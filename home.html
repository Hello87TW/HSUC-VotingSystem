<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新中聯合委員會投票系統</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f8f9fa; }
    .navbar { background: #e3f2fd; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
    .logo { height: 40px; cursor: pointer; }
    .nav-center { flex: 1; text-align: center; }
    .nav-center button { margin: 0 10px; padding: 8px 20px; font-size: 1rem; border: none; border-radius: 6px; background: #1976d2; color: white; cursor: pointer; }
    .nav-center button:hover { background: #1565c0; }
    .user-menu { position: relative; }
    .user-email { cursor: pointer; font-size: 1rem; color: #333; }
    .dropdown { display: none; position: absolute; right: 0; top: 120%; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; overflow: hidden; }
    .dropdown button { width: 100%; padding: 10px; border: none; background: white; cursor: pointer; font-size: 0.95rem; }
    .dropdown button:hover { background: #f0f0f0; }
    .container { max-width: 800px; margin: 60px auto; text-align: center; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1 { color: #1976d2; }
    .welcome { font-size: 1.3rem; margin: 20px 0; }
    .links button { margin: 15px; padding: 12px 30px; background: #1976d2; color: white; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; }
    .links button:hover { background: #1565c0; }
    .login-form { max-width: 400px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .login-form input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    .login-form button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .login-form button:hover { background: #218838; }
    .error { color: #c62828; margin-top: 10px; }
  </style>
</head>
<body>

<nav class="navbar">
  <img src="logo.png" class="logo" onclick="location.href='home.html'">
  <div class="nav-center">
    <button onclick="location.href='user.html'">個人資料</button>
    <button onclick="location.href='vote.html'">投票</button>
  </div>
  <div class="user-menu">
    <div class="user-email" id="userEmail">載入中...</div>
    <div class="dropdown" id="dropdownMenu">
      <button id="resetPwBtn">修改密碼</button>
      <button id="logoutBtn">登出</button>
    </div>
  </div>
</nav>

<div class="container" id="content">
  <!-- 未登入顯示登入表單 -->
  <div id="loginSection">
    <h1>登入投票系統</h1>
    <div class="login-form">
      <input id="email" type="email" placeholder="電子郵件" required>
      <input id="password" type="password" placeholder="密碼" required>
      <button onclick="login()">登入</button>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <!-- 已登入顯示歡迎內容 -->
  <div id="welcomeSection" style="display:none;">
    <h1>歡迎來到新中聯合委員會投票系統</h1>
    <p class="welcome">登入帳號：<span id="userEmailDisplay"></span></p>
    <div class="links">
      <button onclick="location.href='user.html'">查看個人資料</button>
      <button onclick="location.href='vote.html'">參加投票</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBIHkWHtMlkb1ehki9M8o_ORHcTajjpq-s",
    authDomain: "hsuc-voting-system.firebaseapp.com",
    projectId: "hsuc-voting-system",
    storageBucket: "hsuc-voting-system.appspot.com",
    messagingSenderId: "406493227121",
    appId: "1:406493227121:web:6a4898d6edf82eb0c213d0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const userEmailEl = document.getElementById('userEmail');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const dropdown = document.getElementById('dropdownMenu');
  const loginSection = document.getElementById('loginSection');
  const welcomeSection = document.getElementById('welcomeSection');

  userEmailEl.onclick = () => {
    if (userEmailEl.textContent !== '未登入') {
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
  };

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-menu')) dropdown.style.display = 'none';
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userEmailEl.textContent = user.email;
      userEmailDisplay.textContent = user.email;
      loginSection.style.display = 'none';
      welcomeSection.style.display = 'block';
    } else {
      userEmailEl.textContent = '未登入';
      userEmailDisplay.textContent = '未登入';
      loginSection.style.display = 'block';
      welcomeSection.style.display = 'none';
    }
  });

  window.login = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const errorEl = document.getElementById('loginError');

    errorEl.textContent = '';

    if (!email || !password) {
      errorEl.textContent = '請填寫完整';
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      let msg = '登入失敗';
      if (e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
        msg = '帳號或密碼錯誤';
      }
      errorEl.textContent = msg;
    }
  };

  document.getElementById('logoutBtn').onclick = async () => {
    await signOut(auth);
  };

  document.getElementById('resetPwBtn').onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;
    await sendPasswordResetEmail(auth, user.email);
    alert('已寄出重設密碼信');
  };
</script>

</body>
</html>