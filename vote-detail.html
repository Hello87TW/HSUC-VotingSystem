<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBIHkWHtMlkb1ehki9M8o_ORHcTajjpq-s",
    authDomain: "hsuc-voting-system.firebaseapp.com",
    projectId: "hsuc-voting-system",
    storageBucket: "hsuc-voting-system.appspot.com",
    messagingSenderId: "406493227121",
    appId: "1:406493227121:web:6a4898d6edf82eb0c213d0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser, voteData, code;

  const urlParams = new URLSearchParams(window.location.search);
  code = urlParams.get('code');
  if (!code || code.length !== 5) {
    alert('無效代碼');
    location.href = 'vote.html';
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert('請先登入');
      location.href = 'home.html';
      return;
    }

    currentUser = user;
    document.getElementById('userEmail').textContent = user.email;

    const voteRef = doc(db, "votes", code);
    const voteSnap = await getDoc(voteRef);

    if (!voteSnap.exists()) {
      alert('投票不存在');
      location.href = 'vote.html';
      return;
    }

    voteData = voteSnap.data();

    document.getElementById('title').textContent = voteData.title;
    document.getElementById('deadline').textContent = voteData.deadline.toDate().toLocaleString();

    // 修改這裡：讀取發起者的姓名
    let creatorName = voteData.creatorEmail;  // 先預設用 email
    if (voteData.creatorUid) {
      const userRef = doc(db, "users", voteData.creatorUid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists() && userSnap.data().name) {
        creatorName = userSnap.data().name;
      }
    }
    document.getElementById('creator').textContent = creatorName;

    document.getElementById('type').textContent = voteData.isNamed ? '記名投票' : '不記名投票';

    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = '';
    voteData.options.forEach((opt, index) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.textContent = opt;
      btn.onclick = () => vote(index);
      optionsList.appendChild(btn);
    });

    const ballotRef = doc(db, "votes", code, "ballots", user.uid);
    const ballotSnap = await getDoc(ballotRef);
    if (ballotSnap.exists()) {
      const choice = ballotSnap.data().choice;
      const btns = document.querySelectorAll('.option-btn');
      if (choice < btns.length) {
        btns[choice].classList.add('selected');
      }
      document.getElementById('msg').textContent = '已投，可修改';
      document.getElementById('msg').className = 'message success';
    }

    showResult();
  });

  async function vote(choiceIndex) {
    if (!currentUser) return;

    const ballotRef = doc(db, "votes", code, "ballots", currentUser.uid);
    const voteRef = doc(db, "votes", code);

    try {
      await setDoc(ballotRef, {
        choice: choiceIndex,
        timestamp: new Date()
      }, { merge: true });

      await updateDoc(voteRef, {
        participants: voteData.participants + 1
      });

      document.querySelectorAll('.option-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i === choiceIndex);
      });

      document.getElementById('msg').textContent = '投票成功！';
      document.getElementById('msg').className = 'message success';

      showResult();
    } catch (e) {
      document.getElementById('msg').textContent = '投票失敗';
      document.getElementById('msg').className = 'message error';
      console.error(e);
    }
  }

  async function showResult() {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<h2>投票結果</h2>';

    const ballotsSnap = await getDocs(collection(db, "votes", code, "ballots"));
    const totalVotes = ballotsSnap.size;

    if (voteData.isNamed) {
      let html = '<p>總票數：' + totalVotes + '</p><ul>';
      ballotsSnap.forEach(doc => {
        const choice = doc.data().choice;
        html += `<li>${doc.id}: 投 ${voteData.options[choice]}</li>`;
      });
      html += '</ul>';
      resultDiv.innerHTML += html;
    } else {
      const counts = new Array(voteData.options.length).fill(0);
      ballotsSnap.forEach(doc => {
        const choice = doc.data().choice;
        counts[choice]++;
      });

      let html = '<p>總票數：' + totalVotes + '</p>';
      html += '<p class="anonymous-note">（不記名投票，不顯示投票者身分）</p>';
      html += '<ul>';
      voteData.options.forEach((opt, i) => {
        html += `<li>${opt}: ${counts[i]} 票</li>`;
      });
      html += '</ul>';
      resultDiv.innerHTML += html;
    }

    resultDiv.style.display = 'block';
  }

  document.getElementById('logoutBtn').onclick = async () => {
    await signOut(auth);
  };

  document.getElementById('resetPwBtn').onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;
    await sendPasswordResetEmail(auth, user.email);
    alert('已寄出重設密碼信');
  };
</script>
